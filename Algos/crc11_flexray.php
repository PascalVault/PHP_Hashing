<?php
//CRC-11 Flexray
//Author: domasz
//Version: 0.1 (2022-11-17)
//Licence: MIT

require_once 'HasherBase.php';

class HasherCRC11_flexray extends HasherBase
{
	protected $FHash;

	protected $Table = array(
	0x0000, 0x0385, 0x070A, 0x048F, 0x0591, 0x0614, 0x029B, 0x011E, 
	0x00A7, 0x0322, 0x07AD, 0x0428, 0x0536, 0x06B3, 0x023C, 0x01B9, 
	0x014E, 0x02CB, 0x0644, 0x05C1, 0x04DF, 0x075A, 0x03D5, 0x0050, 
	0x01E9, 0x026C, 0x06E3, 0x0566, 0x0478, 0x07FD, 0x0372, 0x00F7, 
	0x029C, 0x0119, 0x0596, 0x0613, 0x070D, 0x0488, 0x0007, 0x0382, 
	0x023B, 0x01BE, 0x0531, 0x06B4, 0x07AA, 0x042F, 0x00A0, 0x0325, 
	0x03D2, 0x0057, 0x04D8, 0x075D, 0x0643, 0x05C6, 0x0149, 0x02CC, 
	0x0375, 0x00F0, 0x047F, 0x07FA, 0x06E4, 0x0561, 0x01EE, 0x026B, 
	0x0538, 0x06BD, 0x0232, 0x01B7, 0x00A9, 0x032C, 0x07A3, 0x0426, 
	0x059F, 0x061A, 0x0295, 0x0110, 0x000E, 0x038B, 0x0704, 0x0481, 
	0x0476, 0x07F3, 0x037C, 0x00F9, 0x01E7, 0x0262, 0x06ED, 0x0568, 
	0x04D1, 0x0754, 0x03DB, 0x005E, 0x0140, 0x02C5, 0x064A, 0x05CF, 
	0x07A4, 0x0421, 0x00AE, 0x032B, 0x0235, 0x01B0, 0x053F, 0x06BA, 
	0x0703, 0x0486, 0x0009, 0x038C, 0x0292, 0x0117, 0x0598, 0x061D, 
	0x06EA, 0x056F, 0x01E0, 0x0265, 0x037B, 0x00FE, 0x0471, 0x07F4, 
	0x064D, 0x05C8, 0x0147, 0x02C2, 0x03DC, 0x0059, 0x04D6, 0x0753, 
	0x01F5, 0x0270, 0x06FF, 0x057A, 0x0464, 0x07E1, 0x036E, 0x00EB, 
	0x0152, 0x02D7, 0x0658, 0x05DD, 0x04C3, 0x0746, 0x03C9, 0x004C, 
	0x00BB, 0x033E, 0x07B1, 0x0434, 0x052A, 0x06AF, 0x0220, 0x01A5, 
	0x001C, 0x0399, 0x0716, 0x0493, 0x058D, 0x0608, 0x0287, 0x0102, 
	0x0369, 0x00EC, 0x0463, 0x07E6, 0x06F8, 0x057D, 0x01F2, 0x0277, 
	0x03CE, 0x004B, 0x04C4, 0x0741, 0x065F, 0x05DA, 0x0155, 0x02D0, 
	0x0227, 0x01A2, 0x052D, 0x06A8, 0x07B6, 0x0433, 0x00BC, 0x0339, 
	0x0280, 0x0105, 0x058A, 0x060F, 0x0711, 0x0494, 0x001B, 0x039E, 
	0x04CD, 0x0748, 0x03C7, 0x0042, 0x015C, 0x02D9, 0x0656, 0x05D3, 
	0x046A, 0x07EF, 0x0360, 0x00E5, 0x01FB, 0x027E, 0x06F1, 0x0574, 
	0x0583, 0x0606, 0x0289, 0x010C, 0x0012, 0x0397, 0x0718, 0x049D, 
	0x0524, 0x06A1, 0x022E, 0x01AB, 0x00B5, 0x0330, 0x07BF, 0x043A, 
	0x0651, 0x05D4, 0x015B, 0x02DE, 0x03C0, 0x0045, 0x04CA, 0x074F, 
	0x06F6, 0x0573, 0x01FC, 0x0279, 0x0367, 0x00E2, 0x046D, 0x07E8, 
	0x071F, 0x049A, 0x0015, 0x0390, 0x028E, 0x010B, 0x0584, 0x0601, 
	0x07B8, 0x043D, 0x00B2, 0x0337, 0x0229, 0x01AC, 0x0523, 0x06A6
	);

	public function __construct()
	{	
		$this->FHash = 0x01A;
		$this->Check = '5A3';
	}
	
	public function Update($Msg, $Length)	
	{
		for ($i=0; $i<$Length; $i++)
		{
			$this->FHash = ($this->FHash << 8) ^ $this->Table[(ord($Msg[$i]) ^ ($this->FHash >> 3)) & 0xFF];
		}   
	}
	
	public function Finish()
	{
		$this->FHash = $this->FHash & 0x7FF;
		
		return sprintf('%03X', $this->FHash);
	}
}

$HasherList->RegisterHasher('CRC-11 Flexray', 'HasherCRC11_flexray');


