<?php
//CRC-21 CAN-FD
//Author: domasz
//Version: 0.1 (2022-11-17)
//Licence: MIT

require_once 'HasherBase.php';

class Hashercrc21_canfd extends HasherBase
{
	protected $FHash;
	
	protected $Table = array(
	0x00000000, 0x00102899, 0x001079AB, 0x00005132, 0x0010DBCF, 0x0000F356, 0x0000A264, 0x00108AFD,
	0x00119F07, 0x0001B79E, 0x0001E6AC, 0x0011CE35, 0x000144C8, 0x00116C51, 0x00113D63, 0x000115FA,
	0x00131697, 0x00033E0E, 0x00036F3C, 0x001347A5, 0x0003CD58, 0x0013E5C1, 0x0013B4F3, 0x00039C6A,
	0x00028990, 0x0012A109, 0x0012F03B, 0x0002D8A2, 0x0012525F, 0x00027AC6, 0x00022BF4, 0x0012036D,
	0x001605B7, 0x00062D2E, 0x00067C1C, 0x00165485, 0x0006DE78, 0x0016F6E1, 0x0016A7D3, 0x00068F4A,
	0x00079AB0, 0x0017B229, 0x0017E31B, 0x0007CB82, 0x0017417F, 0x000769E6, 0x000738D4, 0x0017104D,
	0x00051320, 0x00153BB9, 0x00156A8B, 0x00054212, 0x0015C8EF, 0x0005E076, 0x0005B144, 0x001599DD,
	0x00148C27, 0x0004A4BE, 0x0004F58C, 0x0014DD15, 0x000457E8, 0x00147F71, 0x00142E43, 0x000406DA,
	0x001C23F7, 0x000C0B6E, 0x000C5A5C, 0x001C72C5, 0x000CF838, 0x001CD0A1, 0x001C8193, 0x000CA90A,
	0x000DBCF0, 0x001D9469, 0x001DC55B, 0x000DEDC2, 0x001D673F, 0x000D4FA6, 0x000D1E94, 0x001D360D,
	0x000F3560, 0x001F1DF9, 0x001F4CCB, 0x000F6452, 0x001FEEAF, 0x000FC636, 0x000F9704, 0x001FBF9D,
	0x001EAA67, 0x000E82FE, 0x000ED3CC, 0x001EFB55, 0x000E71A8, 0x001E5931, 0x001E0803, 0x000E209A,
	0x000A2640, 0x001A0ED9, 0x001A5FEB, 0x000A7772, 0x001AFD8F, 0x000AD516, 0x000A8424, 0x001AACBD,
	0x001BB947, 0x000B91DE, 0x000BC0EC, 0x001BE875, 0x000B6288, 0x001B4A11, 0x001B1B23, 0x000B33BA,
	0x001930D7, 0x0009184E, 0x0009497C, 0x001961E5, 0x0009EB18, 0x0019C381, 0x001992B3, 0x0009BA2A,
	0x0008AFD0, 0x00188749, 0x0018D67B, 0x0008FEE2, 0x0018741F, 0x00085C86, 0x00080DB4, 0x0018252D,
	0x00086F77, 0x001847EE, 0x001816DC, 0x00083E45, 0x0018B4B8, 0x00089C21, 0x0008CD13, 0x0018E58A,
	0x0019F070, 0x0009D8E9, 0x000989DB, 0x0019A142, 0x00092BBF, 0x00190326, 0x00195214, 0x00097A8D,
	0x001B79E0, 0x000B5179, 0x000B004B, 0x001B28D2, 0x000BA22F, 0x001B8AB6, 0x001BDB84, 0x000BF31D,
	0x000AE6E7, 0x001ACE7E, 0x001A9F4C, 0x000AB7D5, 0x001A3D28, 0x000A15B1, 0x000A4483, 0x001A6C1A,
	0x001E6AC0, 0x000E4259, 0x000E136B, 0x001E3BF2, 0x000EB10F, 0x001E9996, 0x001EC8A4, 0x000EE03D,
	0x000FF5C7, 0x001FDD5E, 0x001F8C6C, 0x000FA4F5, 0x001F2E08, 0x000F0691, 0x000F57A3, 0x001F7F3A,
	0x000D7C57, 0x001D54CE, 0x001D05FC, 0x000D2D65, 0x001DA798, 0x000D8F01, 0x000DDE33, 0x001DF6AA,
	0x001CE350, 0x000CCBC9, 0x000C9AFB, 0x001CB262, 0x000C389F, 0x001C1006, 0x001C4134, 0x000C69AD,
	0x00144C80, 0x00046419, 0x0004352B, 0x00141DB2, 0x0004974F, 0x0014BFD6, 0x0014EEE4, 0x0004C67D,
	0x0005D387, 0x0015FB1E, 0x0015AA2C, 0x000582B5, 0x00150848, 0x000520D1, 0x000571E3, 0x0015597A,
	0x00075A17, 0x0017728E, 0x001723BC, 0x00070B25, 0x001781D8, 0x0007A941, 0x0007F873, 0x0017D0EA,
	0x0016C510, 0x0006ED89, 0x0006BCBB, 0x00169422, 0x00061EDF, 0x00163646, 0x00166774, 0x00064FED,
	0x00024937, 0x001261AE, 0x0012309C, 0x00021805, 0x001292F8, 0x0002BA61, 0x0002EB53, 0x0012C3CA,
	0x0013D630, 0x0003FEA9, 0x0003AF9B, 0x00138702, 0x00030DFF, 0x00132566, 0x00137454, 0x00035CCD,
	0x00115FA0, 0x00017739, 0x0001260B, 0x00110E92, 0x0001846F, 0x0011ACF6, 0x0011FDC4, 0x0001D55D,
	0x0000C0A7, 0x0010E83E, 0x0010B90C, 0x00009195, 0x00101B68, 0x000033F1, 0x000062C3, 0x00104A5A
	);

	public function __construct()
	{	
		$this->FHash = 0;
		$this->Check = '0ED841';
	}
	
	public function Update($Msg, $Length)	
	{
		for ($i=0; $i<$Length; $i++)
		{
			$this->FHash = ($this->FHash << 8) ^ $this->Table[(ord($Msg[$i]) ^ ($this->FHash >> 13)) & 0xFF];		
		}   
	}
	
	public function Finish()
	{
		$this->FHash = $this->FHash & 0x1FFFFF;		
		return sprintf('%06X', $this->FHash);
	}
}


$HasherList->RegisterHasher('CRC-21 CAN-FD', 'Hashercrc21_canfd');


